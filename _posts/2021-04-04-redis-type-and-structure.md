---
title: Redis 五种基础数据类型及内部数据结构
date: 2021-04-04 15:29:59
categories: Redis  
tags: 
  - Redis
  - NoSQL
---

了解 Redis 的都知道， Redis 有 5 种基础数据类型，他们分别是：**string(字符串)**、**list(列表)**、**hash(散列)**、**set(集合)** 和 **Sorted set(有序集合)**。那么，这五种数据类型，底层又是通过什么数据结构来实现的呢？简单来说，Redis 内部是通过**简单动态字符串**、**双向链表**、**压缩列表**、**哈希表**、**跳表**和**整数数组** 六种数据结构来实现的。但是，Redis 中并没有直接使用这些数据结构直接实现键值对数据库，而是基于这些数据库结构创建了一个包含字**符串对象**、**列表对象**、**哈希对象**、**集合对象**和**有序集合对象**这五种类型的对象。

### 对象类型与编码

Redis 使用对象来存储键和值的，Redis中每个对象都由 redisObject  结构表示，redisObject 结构主要包含type、encoding 和 ptr 三个属性。源码如下所示：

```c
typedef struct redisObject {
    // 类型
    unsigned type:4;
    // 编码
    unsigned encoding:4;
    // 底层数据结构的指针
    void *ptr;
} robj;
```

- type 属性记了对象的类型
- encoding 属性记录了对象所使用的编码，也即是说这个对象使用了什么数据结构作为对象的底层实现。
- *ptr 指针指向 encoding属性决定的对象的底层实现数据结构

之所以用 encoding 属性来决定对象的底层数据结构，是为了实现同一对象类型，支持不同的底层实现。这样就能在不同场景下，使用不同的底层数据结构，进而极大提升Redis的灵活性和效率。

### 字符串对象

Redis 字符串类型是 Redis 中键关联的最简单的值类型，也是最常用的数据类型。

#### 简单动态字符串 SDS

众所周知，Redis 是用 C 语言开发的。但是，Redis 没有直接使用 C 语言传统的字符串表示，而是构建了一个成为简单动态字符串( simple dynamic string, SDS ) 的抽象类型，并将 SDS 作为 Redis 的默认字符串表示。

**SDS 定义**

```c
struct sdshdr {
    unsigned int len; // 字符串长度
    unsigned int free; // 未使用的空间
    char buf[];  // 字符数组，用于保存字符串
};
```

**SDS 与 C 字符串的区别**

为什么不直接使用 C 语言的字符串呢？因为 C 语言这种简单的字符串表示方式 不符合 Redis 对字符串在 安全性、效率和功能方面的要求。我们知道，C 语言使用了一个长度为  N+1 的字符数组来表示长度为 N 的字符串，并且字符数组最后一个元素总是空字符`'\0'`。

Redis 采用 SDS 相对于 C 字符串有如下几个优势：

1. 获取字符串长度的复杂度为 O(1)
2. 杜绝了缓冲区溢出
3. 减少了修改字符串时带来的内存重新分配次数
4. 二进制安全

#### 内部编码

- int：8 个字节的长整型
- raw：大于 39 个字节的字符串
- embstr：小于等于 39 个字节的字符串

 **raw 和 embstr 编码的 SDS 区别**

1. embstr 和 raw 编码一样都是使用 redisObject 结构和 sdshdr 结构来表示字符串对象。
2. embstr 编码是专门用于保存短字符串的一种优化编码方式。
3. raw 编码会调用两次内存分配函数，而 embstr 编码则调用一次内存分配函数来分配一块连续的空间
4. embstr 把内存的分配和释放次数都降低为一次。
5. embstr 是一块连续内存，能够更好低利用缓存带来的优势。

#### 编码转换

1. int 编码和 embstr 编码的字符串对象在条件满足的情况下会自动转换为 raw 编码的字符串对象。
2. 对于 int 编码来说，当我们修改这个字符串为不再是整数值的时候，此时字符串对象的编码就会从 int 变为 raw。
3. 对于 embstr 编码来说，只要我们修改了字符串的值，此时字符串对象的编码就会从 embstr 变为 raw。
4. embstr 编码的字符串对象可以认为是只读的，因为 Redis 为其编写任何修改程序。当我们要修改 embstr 编码字符串时，都是先将转换为 raw 编码，然后再进行修改。

### 列表对象

Redis 的列表相当于 Java 语言中的 LinkedList，因为 list 内部结构是链表，所以 list 的插入和删除操作非常快，时间复杂度为 O(1)，但是索引定位很慢，时间复杂度为 O(n)。



### 散列对象

### 集合对象

### 有序集合对象